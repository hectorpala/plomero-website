name: Monitor del Sitio

on:
  schedule:
    # Corre cada 6 horas
    - cron: '0 */6 * * *'
  workflow_dispatch: # Permite correr manualmente

env:
  SITE_URL: https://plomeroculiacanpro.mx
  SITE_NAME: Plomero CuliacÃ¡n Pro

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verificar que el sitio responda
        id: health
        continue-on-error: true
        run: |
          echo "ðŸ” Verificando ${{ env.SITE_URL }}..."

          # Usar User-Agent de navegador real para evitar bloqueos
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0 Safari/537.36"

          # Reintentar hasta 3 veces con diferentes mÃ©todos
          for i in 1 2 3; do
            HTTP_STATUS=$(curl -sL -o /dev/null -w "%{http_code}" "${{ env.SITE_URL }}" \
              --max-time 30 \
              --retry 2 \
              --retry-delay 3 \
              -H "User-Agent: $UA" \
              -H "Accept: text/html" \
              --compressed \
              2>/dev/null || echo "000")

            if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
              break
            fi
            echo "Intento $i: status $HTTP_STATUS, reintentando..."
            sleep 5
          done

          RESPONSE_TIME=$(curl -sL -o /dev/null -w "%{time_total}" "${{ env.SITE_URL }}" \
            --max-time 30 -H "User-Agent: $UA" 2>/dev/null || echo "0")

          echo "status=$HTTP_STATUS" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Sitio OK - Status $HTTP_STATUS - Tiempo: ${RESPONSE_TIME}s"
            echo "site_ok=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ El sitio respondiÃ³ con status $HTTP_STATUS"
            echo "site_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Verificar pÃ¡ginas importantes
        id: pages
        continue-on-error: true
        run: |
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0 Safari/537.36"

          PAGES=(
            "/"
            "/servicios/reparacion-de-fugas/"
            "/servicios/plomero-colonias-culiacan/las-quintas/"
            "/blog/"
          )

          ERRORS=""
          for page in "${PAGES[@]}"; do
            STATUS=$(curl -sL -o /dev/null -w "%{http_code}" "${{ env.SITE_URL }}${page}" \
              --max-time 15 -H "User-Agent: $UA" 2>/dev/null || echo "000")
            if [ "$STATUS" != "200" ]; then
              ERRORS="${ERRORS}âŒ ${page} -> Status ${STATUS}\n"
            else
              echo "âœ… ${page} -> OK"
            fi
          done

          if [ -n "$ERRORS" ]; then
            echo "pages_ok=false" >> $GITHUB_OUTPUT
            echo -e "errors<<EOF\n${ERRORS}EOF" >> $GITHUB_OUTPUT
          else
            echo "pages_ok=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar Lighthouse
        run: npm install -g lighthouse

      - name: Correr Lighthouse
        id: lighthouse
        continue-on-error: true
        run: |
          echo "ðŸš€ Corriendo Lighthouse..."

          lighthouse ${{ env.SITE_URL }} \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" \
            --only-categories=performance,accessibility,best-practices,seo \
            --quiet

          # Extraer scores
          PERF=$(jq '.categories.performance.score * 100 | floor' lighthouse-report.json)
          ACCESS=$(jq '.categories.accessibility.score * 100 | floor' lighthouse-report.json)
          BP=$(jq '.categories["best-practices"].score * 100 | floor' lighthouse-report.json)
          SEO=$(jq '.categories.seo.score * 100 | floor' lighthouse-report.json)

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$ACCESS" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Resultados:"
          echo "   Performance: $PERF"
          echo "   Accessibility: $ACCESS"
          echo "   Best Practices: $BP"
          echo "   SEO: $SEO"

          # Alerta si performance < 50
          if [ "$PERF" -lt 50 ]; then
            echo "perf_warning=true" >> $GITHUB_OUTPUT
          else
            echo "perf_warning=false" >> $GITHUB_OUTPUT
          fi

      - name: Crear Issue si hay problemas
        if: steps.health.outputs.site_ok == 'false' || steps.pages.outputs.pages_ok == 'false' || steps.lighthouse.outputs.perf_warning == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const siteOk = '${{ steps.health.outputs.site_ok }}' === 'true';
            const pagesOk = '${{ steps.pages.outputs.pages_ok }}' === 'true';
            const perfWarning = '${{ steps.lighthouse.outputs.perf_warning }}' === 'true';

            let title = 'ðŸš¨ Alerta: ';
            let body = '## Reporte de Monitoreo\n\n';
            body += `**Fecha:** ${new Date().toLocaleString('es-MX', {timeZone: 'America/Mazatlan'})}\n\n`;

            if (!siteOk) {
              title += 'Sitio caÃ­do ';
              body += '### âŒ Estado del Sitio\n';
              body += `- Status HTTP: ${{ steps.health.outputs.status }}\n`;
              body += `- Tiempo de respuesta: ${{ steps.health.outputs.response_time }}s\n\n`;
            }

            if (!pagesOk) {
              title += 'PÃ¡ginas con error ';
              body += '### âŒ PÃ¡ginas con Error\n';
              body += '${{ steps.pages.outputs.errors }}\n\n';
            }

            if (perfWarning) {
              title += 'Performance baja';
              body += '### âš ï¸ Performance Baja\n';
            }

            body += '### ðŸ“Š Lighthouse Scores\n';
            body += `| MÃ©trica | Score |\n`;
            body += `|---------|-------|\n`;
            body += `| Performance | ${{ steps.lighthouse.outputs.performance }} |\n`;
            body += `| Accessibility | ${{ steps.lighthouse.outputs.accessibility }} |\n`;
            body += `| Best Practices | ${{ steps.lighthouse.outputs.best_practices }} |\n`;
            body += `| SEO | ${{ steps.lighthouse.outputs.seo }} |\n\n`;

            body += '---\n';
            body += '_Generado automÃ¡ticamente por el Monitor del Sitio_';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'monitor-automatico']
            });

      - name: Resumen
        run: |
          echo "## ðŸ“Š Resumen del Monitoreo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sitio Online | ${{ steps.health.outputs.site_ok == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PÃ¡ginas OK | ${{ steps.pages.outputs.pages_ok == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ steps.lighthouse.outputs.performance }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ steps.lighthouse.outputs.accessibility }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| SEO | ${{ steps.lighthouse.outputs.seo }}% |" >> $GITHUB_STEP_SUMMARY
